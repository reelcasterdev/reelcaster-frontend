name: Daily Data Scraping

on:
  # Run daily at 2 AM UTC (6 PM PST previous day)
  schedule:
    - cron: '0 2 * * *'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      scrape_reports:
        description: 'Scrape fishing reports'
        required: false
        default: 'true'
        type: boolean
      scrape_regulations:
        description: 'Scrape DFO regulations'
        required: false
        default: 'true'
        type: boolean
      weeks_to_check:
        description: 'Weeks to check for reports (checks weekly intervals)'
        required: false
        default: '4'
        type: string

jobs:
  scrape-data:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Scrape DFO Regulations - Area 19 (Victoria, Sidney)
        id: scrape_regulations_area19
        if: ${{ github.event.inputs.scrape_regulations != 'false' }}
        run: |
          echo "ðŸŽ£ Scraping DFO Regulations for Area 19 (Victoria, Sidney)..."

          # Call the production API endpoint for area 19 (public, no auth)
          curl -X POST "${{ secrets.APP_URL }}/api/regulations/scrape?area_id=19" \
            -H "Content-Type: application/json" \
            --fail \
            --show-error \
            --max-time 300 || echo "scrape_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Scrape DFO Regulations - Area 20 (Sooke, Port Renfrew)
        id: scrape_regulations_area20
        if: ${{ github.event.inputs.scrape_regulations != 'false' }}
        run: |
          echo "ðŸŽ£ Scraping DFO Regulations for Area 20 (Sooke, Port Renfrew)..."

          # Call the production API endpoint for area 20 (public, no auth)
          curl -X POST "${{ secrets.APP_URL }}/api/regulations/scrape?area_id=20" \
            -H "Content-Type: application/json" \
            --fail \
            --show-error \
            --max-time 300 || echo "scrape_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Scrape Fishing Reports
        id: scrape_reports
        if: ${{ github.event.inputs.scrape_reports != 'false' }}
        run: |
          echo "ðŸŸ Calling Fishing Reports API endpoint..."
          WEEKS=${{ github.event.inputs.weeks_to_check || '4' }}

          # Call the production API endpoint (public, no auth required)
          # Optimized to check Sundays only and stop after finding first report per location
          curl -X POST "${{ secrets.APP_URL }}/api/fishing-reports/scrape?weeks=$WEEKS" \
            -H "Content-Type: application/json" \
            --fail \
            --show-error \
            --max-time 600 || echo "scrape_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Send Scheduled Notifications
        id: send_notifications
        run: |
          echo "ðŸ“§ Sending scheduled fishing notifications..."

          # Call the notification API endpoint with CRON_SECRET
          curl -X POST "${{ secrets.APP_URL }}/api/notifications/send-scheduled" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --fail \
            --show-error \
            --max-time 600 || echo "notifications_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create summary
        if: always()
        run: |
          echo "# ðŸŽ£ Daily Scraping Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Method:** Direct API calls to production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # DFO Regulations - Area 19
          if [ "${{ steps.scrape_regulations_area19.outcome }}" == "success" ]; then
            echo "### âœ… DFO Regulations - Area 19 (Victoria, Sidney)" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Success" >> $GITHUB_STEP_SUMMARY
            echo "- Endpoint: /api/regulations/scrape?area_id=19" >> $GITHUB_STEP_SUMMARY
            echo "- Storage: Supabase database" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ DFO Regulations - Area 19 (Victoria, Sidney)" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # DFO Regulations - Area 20
          if [ "${{ steps.scrape_regulations_area20.outcome }}" == "success" ]; then
            echo "### âœ… DFO Regulations - Area 20 (Sooke, Port Renfrew)" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Success" >> $GITHUB_STEP_SUMMARY
            echo "- Endpoint: /api/regulations/scrape?area_id=20" >> $GITHUB_STEP_SUMMARY
            echo "- Storage: Supabase database" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ DFO Regulations - Area 20 (Sooke, Port Renfrew)" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fishing Reports
          if [ "${{ steps.scrape_reports.outcome }}" == "success" ]; then
            echo "### âœ… Fishing Reports" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Success" >> $GITHUB_STEP_SUMMARY
            echo "- Endpoint: /api/fishing-reports/scrape" >> $GITHUB_STEP_SUMMARY
            echo "- Storage: Supabase database" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Fishing Reports" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Scheduled Notifications
          if [ "${{ steps.send_notifications.outcome }}" == "success" ]; then
            echo "### âœ… Scheduled Notifications" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Success" >> $GITHUB_STEP_SUMMARY
            echo "- Endpoint: /api/notifications/send-scheduled" >> $GITHUB_STEP_SUMMARY
            echo "- Sent personalized fishing forecasts to users" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Scheduled Notifications" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Failed or Skipped" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Daily scraping workflow failed. Check logs for details."
