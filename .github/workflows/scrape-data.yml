name: Daily Data Scraping

on:
  # Run daily at 2 AM UTC (6 PM PST previous day)
  schedule:
    - cron: '0 2 * * *'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      scrape_reports:
        description: 'Scrape fishing reports'
        required: false
        default: 'true'
        type: boolean
      scrape_regulations:
        description: 'Scrape DFO regulations'
        required: false
        default: 'true'
        type: boolean
      days_to_check:
        description: 'Days to check for reports'
        required: false
        default: '7'
        type: string

jobs:
  scrape-data:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Scrape DFO Regulations
        id: scrape_regulations
        if: ${{ github.event.inputs.scrape_regulations != 'false' }}
        run: |
          echo "ðŸŽ£ Calling DFO Regulations API endpoint..."

          # Call the production API endpoint
          curl -X POST "${{ secrets.APP_URL }}/api/regulations/scrape" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail \
            --show-error \
            --max-time 300 || echo "scrape_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Scrape Fishing Reports
        id: scrape_reports
        if: ${{ github.event.inputs.scrape_reports != 'false' }}
        run: |
          echo "ðŸŸ Calling Fishing Reports API endpoint..."
          DAYS=${{ github.event.inputs.days_to_check || '14' }}

          # Call the production API endpoint
          curl -X POST "${{ secrets.APP_URL }}/api/fishing-reports/scrape?days=$DAYS" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail \
            --show-error \
            --max-time 600 || echo "scrape_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create summary
        if: always()
        run: |
          echo "# ðŸŽ£ Daily Scraping Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Method:** Direct API calls to production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # DFO Regulations
          if [ "${{ steps.scrape_regulations.outcome }}" == "success" ]; then
            echo "### âœ… DFO Regulations" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Success" >> $GITHUB_STEP_SUMMARY
            echo "- Endpoint: /api/regulations/scrape" >> $GITHUB_STEP_SUMMARY
            echo "- Storage: Supabase database" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ DFO Regulations" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fishing Reports
          if [ "${{ steps.scrape_reports.outcome }}" == "success" ]; then
            echo "### âœ… Fishing Reports" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Success" >> $GITHUB_STEP_SUMMARY
            echo "- Endpoint: /api/fishing-reports/scrape" >> $GITHUB_STEP_SUMMARY
            echo "- Storage: Supabase database" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Fishing Reports" >> $GITHUB_STEP_SUMMARY
            echo "- Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Daily scraping workflow failed. Check logs for details."
